<div class="chat-widget" [class.visible]="isVisible" [class.minimized]="isMinimized">
  <!-- Chat Button (when minimized) -->
  <div class="chat-button" (click)="toggleWidget()" *ngIf="isMinimized">
    <div class="chat-icon">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M20 2H4C2.9 2 2 2.9 2 4V22L6 18H20C21.1 18 22 17.1 22 16V4C22 2.9 21.1 2 20 2ZM20 16H5.17L4 17.17V4H20V16Z" fill="currentColor"/>
        <path d="M7 9H17V11H7V9ZM7 12H15V14H7V12Z" fill="currentColor"/>
      </svg>
    </div>
    <div class="notification-dot" *ngIf="turns.length > 1"></div>
  </div>

  <!-- Chat Window -->
  <div class="chat-window" *ngIf="!isMinimized">
    <!-- Header -->
    <div class="chat-header">
      <div class="header-content">
        <div class="avatar">
          <img src="/assets/AIDA.png" alt="AIDA" class="avatar-img">
        </div>
        <div class="header-text">
          <h3>AIDA Assistant</h3>
          <span class="status">Online</span>
        </div>
      </div>
      <button class="minimize-btn" (click)="toggleWidget()" title="Minimize">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
          <path d="M19 13H5V11H19V13Z" fill="currentColor"/>
        </svg>
      </button>
    </div>

    <!-- Messages -->
    <div class="messages" #chatContainer>
      <div class="welcome" *ngIf="turns.length === 1">
        <div class="welcome-content">
          <h4>Welcome to AIDA!</h4>
          <p>I'm your Advantis Assistant. Ask me anything about your documents, processes, or procedures.</p>
        </div>
      </div>
      
      <div *ngFor="let t of turns; let i = index" class="message-row" [ngClass]="t.role">
        <div class="bubble" [ngClass]="t.role" [innerHTML]="t.html || t.content"></div>
        <button *ngIf="t.role === 'ai'" 
                class="icon-btn speaker"
                [class.active]="speakingIndex === i"
                (click)="speak(t.content, i)"
                [title]="speakingIndex === i ? 'Stop' : 'Speak'">
          {{ speakingIndex === i ? '‚è∏' : 'üîä' }}
        </button>
      </div>
      
      <div *ngIf="pending" class="bubble ai">
        <div class="typing-indicator">
          <span></span>
          <span></span>
          <span></span>
        </div>
      </div>
    </div>

    <!-- Input Area -->
    <div class="composer">
      <div class="input-row">
        <textarea #input 
                  class="input" 
                  rows="1" 
                  placeholder="Type your message..."
                  (keydown)="keyDown($event)"
                  (input)="adjustTextareaHeight($event)"></textarea>
        <div class="actions">
          <button class="icon-btn mic" 
                  [class.active]="isRecording" 
                  (click)="toggleMic()" 
                  [title]="isRecording ? 'Stop Recording' : 'Voice Input'">
            {{ isRecording ? '‚è∫' : 'üé§' }}
          </button>
          <button class="send-btn" (click)="send()" [disabled]="pending">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
              <path d="M2.01 21L23 12L2.01 3L2 10L17 12L2 14L2.01 21Z" fill="currentColor"/>
            </svg>
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
